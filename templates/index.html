<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Hungry Hippos</title>
    <link rel='stylesheet' href='{{url_for('static', filename='styles.css')}}' />
    {{ moment.include_moment() }}
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>

  </head>
  <body>
    <h2>ALL MY ITEMS HUNGRY BOIS</h2>
    <section class="items">
      {% for i in items %}
      <div class="item">
        {% if 'cover_picture' in i.store %}
          {% if 'current_url' in i.store.cover_picture %}
            <img class="store-image" src="{{i.store.cover_picture.current_url}}" alt="store picture"/>
          {% endif %}
        {% endif %}

        <div class="item-info">
          <h2>{{i.display_name }}</h2>
            <div id="map-{{loop.index0}}" class="leaflet-map"></div>
            <div class="duration"></div>

            {% if 'average_overall_rating' in i.item %}
            {% if 'average_overall_rating' in i.item.average_overall_rating %}
              <p>Rating: {{i.item.average_overall_rating.average_overall_rating|round(2)}}</p>
            {% endif %}
          {% endif %}

          {% if 'item_price' in i.item %}
            {% if 'minor_units' in i.item.item_price %}
              <p>Price: ${{i.item.item_price.minor_units/100}}</p>
            {% endif %}
          {% endif %}

          {% if 'pickup_interval' in i %}
            {% if 'start' in i.pickup_interval %}
              <p>Pickup start time: {{moment(i.pickup_interval.start).format('HH:mm')}}</p>
            {% endif %}
            {% if 'end' in i.pickup_interval %}
              <p>Pickup end time: {{moment(i.pickup_interval.end).format('HH:mm')}}</p>
            {% endif %}
          {% endif %}

          <p>Order window ends {{moment(i.purchase_end).fromNow() }}</>
        </div>


        <img class="qr-code" src="data:image/png;base64, {{i.qrcode}}" alt="Share link" />
      </div>

      {% endfor %}
    </section>
  </body>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
              integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
              crossorigin=""></script>
    <script>
        const maps = document.querySelectorAll('.leaflet-map');
        const durations = document.querySelectorAll('.duration');
        const parsedItems = {{  items|tojson }}

        const recurseLatitude = 40.6913289;
        const recurseLongitude = -73.985069;

        function drawDirections(index) {
            const pickupLatitude = parsedItems[index]['pickup_location']['location']['latitude'];
            const pickupLongitude = parsedItems[index]['pickup_location']['location']['longitude'];
            const centerLatitude = (recurseLatitude + pickupLatitude) / 2;
            const centerLongitude = (recurseLongitude + pickupLongitude) / 2;

            const map = L.map(`map-${index}`).setView([centerLatitude, centerLongitude], 16);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            const geoJSON = parsedItems[index]['osm_geojson']
            L.geoJSON(geoJSON).addTo(map);

            const durationInSeconds = geoJSON['features'][0]['properties']['summary']['duration'];
            durations[index].innerText = `Walking distance: ${Math.ceil(durationInSeconds/ 60)} minutes`
        }

        for (const [index, _map] of maps.entries()) drawDirections(index);
    </script>
</html>
